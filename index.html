<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#ff8fb1" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>计数伴侣</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" href="icons/icon.svg" type="image/svg+xml" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  </head>
  <body>
    <div id="app">
      <!-- Full-window app shell -->
      <div id="panel" class="panel">
        <div class="panel-inner">
          <div id="panel-header" class="panel-header">
            <div class="title">计数伴侣</div>
            <div class="header-actions">
              <button id="btn-clear" class="danger" aria-label="清空所有数据">清空</button>
              <button id="cloud-indicator" class="btn-icon ghost round" aria-label="云同步状态" data-state="idle">
                <!-- 轴对称云图标（重新居中，旋转更稳定） -->
                <svg width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <!-- 对称云形：围绕 x=12 的两段弧线，底边圆角 -->
                  <path class="cloud-fill" d="M5 17h14a3.5 3.5 0 0 0 0-7h0A5.8 5.8 0 0 0 12 6.2A5.8 5.8 0 0 0 5 10H5a4 4 0 0 0 0 7Z"/>
                  <path class="cloud-stroke" d="M5 17h14a3.5 3.5 0 0 0 0-7h0A5.8 5.8 0 0 0 12 6.2A5.8 5.8 0 0 0 5 10H5a4 4 0 0 0 0 7Z"/>
                </svg>
              </button>
              <button id="btn-global-menu" class="btn-ellipsis ghost round btn-icon" aria-label="更多">
                <span class="dots"><i></i><i></i><i></i></span>
              </button>
              <input id="file-import" type="file" accept="application/json" hidden />
            </div>
          </div>

          <!-- Decorative ornaments (subtle, can be removed easily) -->
          <div class="ornaments" aria-hidden="true">
            <!-- Top-left accent sketch -->
            <svg class="orn tl" width="240" height="160" viewBox="0 0 240 160" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g opacity="0.6">
                <rect x="-20" y="-10" width="160" height="80" rx="18" transform="rotate(-12 0 0)" style="fill: var(--accent); opacity: .06"/>
                <circle cx="56" cy="28" r="20" style="stroke: var(--accent); stroke-width: 2; opacity: .35; fill: none;"/>
                <circle cx="112" cy="44" r="10" style="fill: var(--accent-2); opacity: .18;"/>
                <circle cx="132" cy="24" r="4" style="fill: var(--accent); opacity: .45;"/>
                <circle cx="86" cy="64" r="3" style="fill: var(--accent); opacity: .35;"/>
              </g>
            </svg>
            <!-- Bottom-right dashed ring -->
            <svg class="orn br" width="260" height="200" viewBox="0 0 260 200" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g opacity="0.7">
                <circle cx="200" cy="150" r="46" style="stroke: var(--accent-2); stroke-width: 2; stroke-dasharray: 6 8; opacity: .45; fill: none;"/>
                <circle cx="200" cy="150" r="24" style="stroke: var(--accent); stroke-width: 2; opacity: .25; fill: none;"/>
                <rect x="150" y="110" width="40" height="16" rx="8" style="fill: var(--accent); opacity: .10;"/>
                <circle cx="224" cy="120" r="5" style="fill: var(--accent); opacity: .35;"/>
              </g>
            </svg>
            <!-- New subtle accents: top-right sparkles -->
            <svg class="orn tr" width="200" height="160" viewBox="0 0 200 160" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g opacity="0.55">
                <circle cx="162" cy="22" r="3" style="fill: var(--accent); opacity:.5"/>
                <circle cx="146" cy="44" r="6" style="fill: var(--accent-2); opacity:.2"/>
                <circle cx="180" cy="54" r="2" style="fill: var(--accent); opacity:.45"/>
                <rect x="120" y="18" width="32" height="12" rx="6" style="fill: var(--accent); opacity:.08"/>
              </g>
            </svg>
            <!-- New subtle accents: bottom-left arc -->
            <svg class="orn bl" width="220" height="180" viewBox="0 0 220 180" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g opacity="0.5">
                <path d="M20 160 C 60 120, 100 140, 160 110" stroke="currentColor" style="color: var(--accent-2); stroke-width:2; stroke-dasharray:5 7; opacity:.5" fill="none"/>
                <circle cx="48" cy="148" r="4" style="fill: var(--accent); opacity:.35"/>
                <circle cx="92" cy="136" r="3" style="fill: var(--accent); opacity:.3"/>
              </g>
            </svg>
            <!-- Top-middle gentle waves -->
            <svg class="orn tm" width="260" height="60" viewBox="0 0 260 60" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g opacity="0.35">
                <path d="M0 40 C 40 20, 80 60, 120 36 C 160 14, 200 58, 240 34" stroke="currentColor" style="color: var(--accent); stroke-width: 2; opacity:.35"/>
                <path d="M8 48 C 48 28, 88 54, 128 32 C 168 10, 208 56, 252 30" stroke="currentColor" style="color: var(--accent-2); stroke-width: 2; opacity:.2"/>
              </g>
            </svg>
            <!-- Middle-left dotted block -->
            <svg class="orn ml" width="140" height="140" viewBox="0 0 140 140" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g opacity="0.45">
                <rect x="10" y="10" width="96" height="56" rx="12" style="fill: var(--accent); opacity:.06"/>
                <g style="opacity:.35; fill: var(--accent);">
                  <circle cx="26" cy="26" r="2"/>
                  <circle cx="46" cy="26" r="2"/>
                  <circle cx="66" cy="26" r="2"/>
                  <circle cx="86" cy="26" r="2"/>
                  <circle cx="26" cy="46" r="2"/>
                  <circle cx="46" cy="46" r="2"/>
                  <circle cx="66" cy="46" r="2"/>
                  <circle cx="86" cy="46" r="2"/>
                </g>
              </g>
            </svg>
          </div>

          <div class="panel-toolbar">
            <button id="btn-add" class="tonal">+ 新建计数器</button>
            <label class="opacity-label">透明度
              <input id="opacity" type="range" min="70" max="100" value="100" />
            </label>
            <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
              <button id="btn-archived" class="tonal" aria-label="查看归档">查看归档</button>
              <button id="theme-toggle" class="tonal" aria-label="切换主题">主题</button>
            </div>
          </div>

          <div id="counters" class="counters"></div>

          <!-- App footer -->
          <footer class="app-footer" aria-label="网站底部信息">
            <span id="footer-copy">© <span id="footer-year"></span> 计数伴侣 made by 尘</span>
            <span class="sep">·</span>
            <button type="button" id="footer-help" class="footer-link">帮助</button>
          </footer>
        </div>
      </div>
    </div>

    <!-- History modal -->
    <dialog id="history-dialog" class="modal">
      <div class="modal-header">
        <div class="modal-title">历史记录</div>
        <button id="history-close">关闭</button>
      </div>
      <div class="modal-body">
        <div id="history-meta" class="history-meta"></div>
        <ul id="history-list" class="history-list"></ul>
      </div>
    </dialog>

    <!-- Rename modal -->
    <dialog id="rename-dialog" class="modal">
      <div class="modal-header">
        <div class="modal-title">重命名计数器</div>
        <button id="rename-close">关闭</button>
      </div>
      <div class="modal-body">
        <input id="rename-input" type="text" placeholder="新的名称"
          autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"
          inputmode="text" enterkeyhint="done" name="rename" />
        <div class="modal-actions">
          <button id="rename-ok">确定</button>
        </div>
      </div>
    </dialog>

    <!-- Confirm modal (app-style, replaces browser confirm) -->
    <dialog id="confirm-dialog" class="modal confirm">
      <div class="modal-header">
        <div id="confirm-title" class="modal-title">请确认</div>
      </div>
      <div class="modal-body">
        <div id="confirm-text" class="confirm-text"></div>
        <div class="modal-actions">
          <button id="confirm-cancel">取消</button>
          <button id="confirm-ok" class="danger">确定</button>
        </div>
      </div>
    </dialog>

    <!-- Info modal (app-style alert) -->
    <dialog id="info-dialog" class="modal">
      <div class="modal-header">
        <div id="info-title" class="modal-title">提示</div>
      </div>
      <div class="modal-body">
        <div id="info-text" class="confirm-text"></div>
        <div class="modal-actions">
          <button id="info-ok" class="primary">知道了</button>
        </div>
      </div>
    </dialog>

    <!-- Privacy dialog removed; content merged into Help -->

    <!-- Sync settings dialog -->
    <dialog id="sync-dialog" class="modal">
      <div class="modal-header">
        <div class="modal-title">同步设置</div>
        <button id="sync-close">关闭</button>
      </div>
      <div class="modal-body">
        <div class="muted" style="margin-bottom:8px; line-height:1.6;">
          使用 JSONBin 进行云同步。填写 Bin ID 与 API Key 后保存。提示：API Key 相当于写入权限的钥匙，请勿外泄。
        </div>
        <hr class="section-sep" />
        <div class="field-row">
          <div class="field-label">自动同步</div>
          <label class="switch">
            <input id="sync-auto" type="checkbox" />
            <span class="slider" aria-hidden="true"></span>
          </label>
        </div>
        <label style="display:block; margin-bottom:8px;">
          Bin ID
          <input id="sync-binid" type="text" placeholder="例如：660e..." autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" inputmode="text" name="sync-binid" />
        </label>
        <label style="display:block; margin-bottom:6px;">
          API Key
          <div class="input-row">
            <input id="sync-apikey" type="password" placeholder="以 X-Master-Key 使用" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" inputmode="text" name="sync-apikey" />
            <button id="sync-apikey-toggle" class="ghost" type="button" aria-pressed="false" aria-controls="sync-apikey" title="显示/隐藏 API Key">显示</button>
          </div>
        </label>
        <div id="sync-status" class="muted"></div>
        <div class="modal-actions">
          <button id="sync-save" class="primary">保存</button>
        </div>
        <details class="advanced">
          <summary>高级设置</summary>
          <div class="adv-content">
            <div class="modal-actions">
            <button id="sync-pull" class="danger">仅拉取（覆盖本地）</button>
            <button id="sync-upload" class="tonal">仅上传（覆盖云端）</button>
            <button id="sync-test" class="tonal">测试连接</button>
            <button id="sync-unlink" class="ghost">解除绑定</button>
            </div>
          </div>
        </details>
      </div>
    </dialog>

    <!-- Help dialog -->
    <dialog id="help-dialog" class="modal">
      <div class="modal-header">
        <div class="modal-title">欢迎使用 · 计数伴侣</div>
        <button id="help-close">关闭</button>
      </div>
      <div class="modal-body">
        <p class="muted"><strong>项目仓库</strong>：
          <a href="https://github.com/125tiantian/counter-buddy" target="_blank" rel="noopener noreferrer">github.com/125tiantian/counter-buddy</a>
        </p>
        <hr class="section-sep" />

        <section class="help-section" id="help-what">
          <h3 class="section-title">这是什么</h3>
          <p>计数伴侣是一个轻量、可离线的多计数器工具。
            用简单的 <span class="kbd">+1</span> 记录反复发生的事情，并用 <span class="kbd">记</span> 写下原因或备注。
            无账号、默认本地保存，支持可选云同步。</p>
        </section>

        <section class="help-section" id="help-scenes">
          <h3 class="section-title">常见场景</h3>
          <ul>
            <li>习惯打卡（学习、健身、喝水）与进度记录</li>
            <li>事件统计（bug、胜场、跑步次数）</li>
            <li>里程碑与原因记录（用 <span class="kbd">记</span> 不加一）</li>
          </ul>
        </section>

        <section class="help-section" id="help-basics">
          <h3 class="section-title">基础功能</h3>
          <ul>
            <li>点 <span class="kbd">+ 新建计数器</span> 创建新计数器；点击卡片上的 <span class="kbd">+1</span> 增加计数。</li>
            <li>为这次 <span class="kbd">+1</span> 添加备注：长按 <span class="kbd">+1</span>，或按住 <span class="kbd">Shift</span> 再点。</li>
            <li><span class="kbd">记</span>：只添加一条“记录”备注，不改变总数，适合写原因/里程碑。</li>
            <li>历史：为每次 <span class="kbd">+1</span>/记录 添加或编辑备注；删除 <span class="kbd">+1</span> 会回退计数，“记录”删除不改变计数。</li>
            <li>管理：重命名、排序（拖动/更多中上移下移置顶置底）、重置/删除、归档/取消归档。</li>
            <li>导入/导出：右上角“更多”可导入/导出 JSON；支持安装为应用（PWA）。</li>
          </ul>
        </section>

        <section class="help-section" id="help-sync">
          <details class="advanced">
            <summary>云同步（可选）：多设备与备份</summary>
            <div class="adv-content">
              <div>
                <ul>
                  <li><strong>用途</strong>：在多设备之间合并同步；换手机/清缓存后快速恢复；作为在线备份。</li>
                  <li><strong>工作方式</strong>：点击右上角云图标手动“合并同步”；也可在“同步设置”里开启自动同步。</li>
                </ul>
                <p><strong>方法介绍（JSONBin）</strong></p>
                <ol>
                  <li>访问 <a href="https://jsonbin.io/create-account" target="_blank" rel="noopener noreferrer">jsonbin.io</a> 注册并登录。</li>
                  <li>左侧进入 <em>Bins</em> → 点击 <em>Create a Bin</em>。</li>
                  <li>在输入框粘贴下方默认 JSON（可直接复制）。</li>
                  <li>点击 <em>Save Bin</em> 保存。</li>
                  <li>左侧复制该 Bin 的 <strong>Bin ID</strong>。</li>
                  <li>左侧进入 <em>API Keys</em>，复制 <strong>X‑Master‑Key</strong>。</li>
                  <li>回到应用“同步设置”，粘贴 <em>Bin ID</em> 与 <em>X‑Master‑Key</em> 并保存。</li>
                </ol>
                <div class="muted" style="margin: 6px 0 4px;">默认 JSON（点击右上角复制按钮）：</div>
                <pre id="jsonbin-default" style="position: relative; background: var(--surface); border: 1px solid var(--input-border); padding: 8px 72px 8px 8px; border-radius: 8px; white-space: pre; overflow: auto;">
<button id="copy-default-json" type="button" class="ghost copy-btn">复制</button>{
  "counters": [],
  "ui": { "panel": { "x": null, "y": null, "w": null, "h": null }, "theme": "pink" }
}
</pre>
                <p class="muted">提示：若在“测试连接”中出现 404，通常是 Bin 尚未创建；请先在 JSONBin 创建并保存一个 Bin。</p>
                <p><strong>功能介绍</strong>：点击右上角云图标可手动“合并同步”（读取云端 → 合并 → 条件写回）；可在设置中开启“自动同步”。</p>
                <p><strong>多设备同步</strong>：在其它设备打开本应用，填入相同的 <em>Bin ID</em> 与 <em>X‑Master‑Key</em> 并保存，即可合并并保持同步。</p>
                <p><strong>按钮说明</strong>：</p>
                <ul>
                  <li><strong>云图标</strong>：点击手动同步；悬停/长按查看状态（同步中旋转、成功实心、失败红色、离线带斜杠）。</li>
                  <li><strong>同步设置</strong>：<em>自动同步</em> 开关、<em>保存</em>；<em>高级设置</em> 中含 <em>仅拉取（覆盖本地）</em>、<em>仅上传（覆盖云端）</em>、<em>测试连接</em>、<em>解除绑定</em>；<em>显示/隐藏 API Key</em> 用于临时查看密钥。</li>
                </ul>
              </div>
            </div>
          </details>
        </section>

        <section class="help-section" id="help-install">
          <details class="advanced">
            <summary>应用安装（PWA）</summary>
            <div class="adv-content">
              <div>
                <ul>
                  <li><strong>支持环境</strong>：Chrome（推荐）或 Microsoft Edge 浏览器（Edge 可在应用商店下载）。</li>
                  <li><strong>电脑</strong>：在浏览器右上角的“三个点”菜单中，选择“保存和分享/更多工具” → “安装为应用”。</li>
                  <li><strong>手机</strong>：在浏览器右上角的“三个点”菜单中，选择“添加到主屏幕/安装应用”。如出现权限提示，请在系统设置中为浏览器开启“安装应用”的权限。</li>
                  <li><strong>Google Play</strong>：如果设备支持 Google Play 服务，且设备网络环境可连接 Google，在该环境下安装会以 WebAPK 形式集成到系统，体验更接近原生应用。</li>
                </ul>
              </div>
            </div>
          </details>
        </section>

        <section class="help-section" id="help-privacy">
          <details class="advanced">
            <summary>隐私与数据</summary>
            <div class="adv-content">
              <div>
                <p>默认数据仅保存在你的浏览器（localStorage），不会上传到我们的服务器。</p>
                <p>启用云同步时，浏览器会直接与 JSONBin 通信；<strong>Bin ID</strong> 与 <strong>X‑Master‑Key</strong> 仅保存在本机。我们不会收集或存储你的数据或密钥。</p>
                <ul>
                  <li>解除绑定：在“同步设置 → 高级设置”点击“解除绑定”，仅清除本机保存的 Bin ID 与 Key，不会删除 JSONBin 上的数据。</li>
                  <li>离线可用：无网络也能使用；若开启自动同步，网络恢复后会自动重试。</li>
                  <li>本地清除：右上“清空”仅删除本机数据；可随时导入/导出 JSON 做离线备份。</li>
                </ul>
              </div>
            </div>
          </details>
        </section>

        

        <div class="muted">小提示：对话框内按 Enter 保存、Esc 取消；云同步细节与 FAQ 见仓库 README。</div>
      </div>
    </dialog>

    <script src="app.js"></script>
    <script>
      // Register Service Worker. On localhost, still enable SW when running as an installed PWA
      // so the app can work offline without the local Python server.
      (function() {
        if (!('serviceWorker' in navigator)) return;
        const isLocalhost = /^(localhost|127\.0\.0\.1)$/i.test(location.hostname);
        const isStandalone = (window.matchMedia && (
          window.matchMedia('(display-mode: standalone)').matches ||
          window.matchMedia('(display-mode: window-controls-overlay)').matches
        )) || (navigator.standalone === true);

        // In normal browser tabs on localhost, avoid SW to keep dev simple
        if (isLocalhost && !isStandalone) {
          navigator.serviceWorker.getRegistrations().then((regs) => {
            if (regs && regs.length) {
              Promise.all(regs.map(r => r.unregister())).then(() => {
                if (navigator.serviceWorker.controller) {
                  location.reload();
                }
              });
            }
          });
          return;
        }

        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (refreshing) return; refreshing = true;
          location.reload();
        });
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' })
            .then((reg) => { try { if (reg && typeof reg.update === 'function') reg.update(); } catch(e){} })
            .catch((e) => console.debug('SW register failed', e));
        });
      })();
    </script>
  </body>
  </html>
