<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#ff8fb1" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>计数伴侣</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" href="icons/icon.svg" type="image/svg+xml" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  </head>
  <body>
    <div id="app">
      <!-- Full-window app shell -->
      <div id="panel" class="panel">
        <div class="panel-inner">
          <div id="panel-header" class="panel-header">
            <div class="title">计数伴侣</div>
            <div class="header-actions">
              <button id="btn-clear" class="danger" aria-label="清空所有数据">清空</button>
              <button id="cloud-indicator" class="btn-icon ghost round" aria-label="云同步状态" data-state="idle">
                <!-- 轴对称云图标（重新居中，旋转更稳定） -->
                <svg width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <!-- 对称云形：围绕 x=12 的两段弧线，底边圆角 -->
                  <path class="cloud-fill" d="M5 17h14a3.5 3.5 0 0 0 0-7h0A5.8 5.8 0 0 0 12 6.2A5.8 5.8 0 0 0 5 10H5a4 4 0 0 0 0 7Z"/>
                  <path class="cloud-stroke" d="M5 17h14a3.5 3.5 0 0 0 0-7h0A5.8 5.8 0 0 0 12 6.2A5.8 5.8 0 0 0 5 10H5a4 4 0 0 0 0 7Z"/>
                </svg>
              </button>
              <button id="btn-global-menu" class="btn-ellipsis ghost round btn-icon" aria-label="更多">
                <span class="dots"><i></i><i></i><i></i></span>
              </button>
              <input id="file-import" type="file" accept="application/json" hidden />
            </div>
          </div>

          <!-- Decorative ornaments (subtle, can be removed easily) -->
          <div class="ornaments" aria-hidden="true">
            <!-- Top-left accent sketch -->
            <svg class="orn tl" width="240" height="160" viewBox="0 0 240 160" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g opacity="0.6">
                <rect x="-20" y="-10" width="160" height="80" rx="18" transform="rotate(-12 0 0)" style="fill: var(--accent); opacity: .06"/>
                <circle cx="56" cy="28" r="20" style="stroke: var(--accent); stroke-width: 2; opacity: .35; fill: none;"/>
                <circle cx="112" cy="44" r="10" style="fill: var(--accent-2); opacity: .18;"/>
                <circle cx="132" cy="24" r="4" style="fill: var(--accent); opacity: .45;"/>
                <circle cx="86" cy="64" r="3" style="fill: var(--accent); opacity: .35;"/>
              </g>
            </svg>
            <!-- Bottom-right dashed ring -->
            <svg class="orn br" width="260" height="200" viewBox="0 0 260 200" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g opacity="0.7">
                <circle cx="200" cy="150" r="46" style="stroke: var(--accent-2); stroke-width: 2; stroke-dasharray: 6 8; opacity: .45; fill: none;"/>
                <circle cx="200" cy="150" r="24" style="stroke: var(--accent); stroke-width: 2; opacity: .25; fill: none;"/>
                <rect x="150" y="110" width="40" height="16" rx="8" style="fill: var(--accent); opacity: .10;"/>
                <circle cx="224" cy="120" r="5" style="fill: var(--accent); opacity: .35;"/>
              </g>
            </svg>
            <!-- New subtle accents: top-right sparkles -->
            <svg class="orn tr" width="200" height="160" viewBox="0 0 200 160" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g opacity="0.55">
                <circle cx="162" cy="22" r="3" style="fill: var(--accent); opacity:.5"/>
                <circle cx="146" cy="44" r="6" style="fill: var(--accent-2); opacity:.2"/>
                <circle cx="180" cy="54" r="2" style="fill: var(--accent); opacity:.45"/>
                <rect x="120" y="18" width="32" height="12" rx="6" style="fill: var(--accent); opacity:.08"/>
              </g>
            </svg>
            <!-- New subtle accents: bottom-left arc -->
            <svg class="orn bl" width="220" height="180" viewBox="0 0 220 180" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g opacity="0.5">
                <path d="M20 160 C 60 120, 100 140, 160 110" stroke="currentColor" style="color: var(--accent-2); stroke-width:2; stroke-dasharray:5 7; opacity:.5" fill="none"/>
                <circle cx="48" cy="148" r="4" style="fill: var(--accent); opacity:.35"/>
                <circle cx="92" cy="136" r="3" style="fill: var(--accent); opacity:.3"/>
              </g>
            </svg>
            <!-- Top-middle gentle waves -->
            <svg class="orn tm" width="260" height="60" viewBox="0 0 260 60" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g opacity="0.35">
                <path d="M0 40 C 40 20, 80 60, 120 36 C 160 14, 200 58, 240 34" stroke="currentColor" style="color: var(--accent); stroke-width: 2; opacity:.35"/>
                <path d="M8 48 C 48 28, 88 54, 128 32 C 168 10, 208 56, 252 30" stroke="currentColor" style="color: var(--accent-2); stroke-width: 2; opacity:.2"/>
              </g>
            </svg>
            <!-- Middle-left dotted block -->
            <svg class="orn ml" width="140" height="140" viewBox="0 0 140 140" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g opacity="0.45">
                <rect x="10" y="10" width="96" height="56" rx="12" style="fill: var(--accent); opacity:.06"/>
                <g style="opacity:.35; fill: var(--accent);">
                  <circle cx="26" cy="26" r="2"/>
                  <circle cx="46" cy="26" r="2"/>
                  <circle cx="66" cy="26" r="2"/>
                  <circle cx="86" cy="26" r="2"/>
                  <circle cx="26" cy="46" r="2"/>
                  <circle cx="46" cy="46" r="2"/>
                  <circle cx="66" cy="46" r="2"/>
                  <circle cx="86" cy="46" r="2"/>
                </g>
              </g>
            </svg>
          </div>

          <div class="panel-toolbar">
            <button id="btn-add" class="tonal">+ 新建计数器</button>
            <label class="opacity-label">透明度
              <input id="opacity" type="range" min="70" max="100" value="100" />
            </label>
            <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
              <button id="theme-toggle" class="tonal" aria-label="切换主题">主题</button>
            </div>
          </div>

          <div id="counters" class="counters"></div>

          <!-- App footer -->
          <footer class="app-footer" aria-label="网站底部信息">
            <span id="footer-copy">© <span id="footer-year"></span> 计数伴侣 made by 尘</span>
            <span class="sep">·</span>
            <button type="button" id="footer-privacy" class="footer-link">隐私</button>
            <span class="sep">·</span>
            <button type="button" id="footer-help" class="footer-link">帮助</button>
          </footer>
        </div>
      </div>
    </div>

    <!-- History modal -->
    <dialog id="history-dialog" class="modal">
      <div class="modal-header">
        <div class="modal-title">历史记录</div>
        <button id="history-close">关闭</button>
      </div>
      <div class="modal-body">
        <div id="history-meta" class="history-meta"></div>
        <ul id="history-list" class="history-list"></ul>
      </div>
    </dialog>

    <!-- Rename modal -->
    <dialog id="rename-dialog" class="modal">
      <div class="modal-header">
        <div class="modal-title">重命名计数器</div>
        <button id="rename-close">关闭</button>
      </div>
      <div class="modal-body">
        <input id="rename-input" type="text" placeholder="新的名称"
          autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"
          inputmode="text" enterkeyhint="done" name="rename" />
        <div class="modal-actions">
          <button id="rename-ok">确定</button>
        </div>
      </div>
    </dialog>

    <!-- Confirm modal (app-style, replaces browser confirm) -->
    <dialog id="confirm-dialog" class="modal confirm">
      <div class="modal-header">
        <div id="confirm-title" class="modal-title">请确认</div>
      </div>
      <div class="modal-body">
        <div id="confirm-text" class="confirm-text"></div>
        <div class="modal-actions">
          <button id="confirm-cancel">取消</button>
          <button id="confirm-ok" class="danger">确定</button>
        </div>
      </div>
    </dialog>

    <!-- Privacy dialog -->
    <dialog id="privacy-dialog" class="modal">
      <div class="modal-header">
        <div class="modal-title">隐私说明</div>
        <button id="privacy-close">关闭</button>
      </div>
      <div class="modal-body">
        <p>本应用默认将计数数据仅存储在您的浏览器本地（localStorage），不会上传到我们的服务器。</p>
        <p>如启用云同步（JSONBin），数据会由您的浏览器直接与 JSONBin API 通信；<strong>Bin ID</strong> 与 <strong>API Key</strong> 仅保存在本机的 localStorage 中，用于访问您自己的 Bin。我们不会收集或存储您的数据或密钥。</p>
        <ul>
          <li>可随时在“同步设置 → 高级设置”中点击“解除绑定”，仅清除本机保存的 Bin ID 与 API Key，不会删除 JSONBin 上的数据。</li>
          <li>离线时应用仍可使用；网络恢复后会根据设置自动重试同步。</li>
          <li>您可随时使用右上角“清空”按钮删除所有本地数据。</li>
        </ul>
      </div>
    </dialog>

    <!-- Sync settings dialog -->
    <dialog id="sync-dialog" class="modal">
      <div class="modal-header">
        <div class="modal-title">同步设置</div>
        <button id="sync-close">关闭</button>
      </div>
      <div class="modal-body">
        <div class="muted" style="margin-bottom:8px; line-height:1.6;">
          使用 JSONBin 进行云同步。填写 Bin ID 与 API Key 后保存。提示：API Key 相当于写入权限的钥匙，请勿外泄。
        </div>
        <hr class="section-sep" />
        <div class="field-row">
          <div class="field-label">自动同步</div>
          <label class="switch">
            <input id="sync-auto" type="checkbox" />
            <span class="slider" aria-hidden="true"></span>
          </label>
        </div>
        <label style="display:block; margin-bottom:8px;">
          Bin ID
          <input id="sync-binid" type="text" placeholder="例如：660e..." autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" inputmode="text" name="sync-binid" />
        </label>
        <label style="display:block; margin-bottom:6px;">
          API Key
          <div class="input-row">
            <input id="sync-apikey" type="password" placeholder="以 X-Master-Key 使用" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" inputmode="text" name="sync-apikey" />
            <button id="sync-apikey-toggle" class="ghost" type="button" aria-pressed="false" aria-controls="sync-apikey" title="显示/隐藏 API Key">显示</button>
          </div>
        </label>
        <div id="sync-status" class="muted"></div>
        <div class="modal-actions">
          <button id="sync-save" class="primary">保存</button>
        </div>
        <details class="advanced">
          <summary>高级设置</summary>
          <div class="adv-content">
            <div class="modal-actions">
            <button id="sync-pull" class="danger">仅拉取（覆盖本地）</button>
            <button id="sync-upload" class="tonal">仅上传（覆盖云端）</button>
            <button id="sync-test" class="tonal">测试连接</button>
            <button id="sync-unlink" class="ghost">解除绑定</button>
            </div>
          </div>
        </details>
      </div>
    </dialog>

    <!-- Help dialog -->
    <dialog id="help-dialog" class="modal">
      <div class="modal-header">
        <div class="modal-title">使用帮助</div>
        <button id="help-close">关闭</button>
      </div>
      <div class="modal-body">
        <p><strong>项目仓库</strong>：<a href="https://github.com/125tiantian/counter-buddy" target="_blank" rel="noopener noreferrer">github.com/125tiantian/counter-buddy</a></p>
        <p><strong>快速上手</strong></p>
        <ul>
          <li>点击 <span class="kbd">+1</span> 增加当前计数。</li>
          <li>长按 <span class="kbd">+1</span>，或按住 <span class="kbd">Shift</span> 再点 <span class="kbd">+1</span>，可为这次 +1 添加备注。</li>
          <li>点击 <span class="kbd">记</span>（快速记录）只添加一条“记录”备注，不改变计数。</li>
          <li>右上角云图标：点击手动进行云同步；悬停（PC）或长按（触屏）查看同步状态。</li>
          <li>首次使用云同步：在“同步设置”里填入 <em>Bin ID</em> 与 <em>X-Master-Key</em> 后保存（见下文指南）。</li>
        </ul>

        <p><strong>云同步（JSONBin）</strong></p>
        <ul>
          <li><strong>方法介绍</strong>：
            <ol>
              <li>打开 <a href="https://jsonbin.io/create-account" target="_blank" rel="noopener noreferrer">jsonbin.io</a> 注册并登录。</li>
              <li>左侧进入 <em>Bins</em>，点击 <em>Create a Bin</em>。</li>
              <li>在输入框粘贴以下默认 JSON（可直接复制）：
                <pre style="background: var(--surface); border: 1px solid var(--input-border); padding: 8px; border-radius: 8px; white-space: pre; overflow: auto;">{
  "counters": [],
  "ui": { "panel": { "x": null, "y": null, "w": null, "h": null }, "theme": "pink" }
}</pre>
              </li>
              <li>点击 <em>Save Bin</em> 保存。</li>
              <li>在左侧复制该 Bin 的 <strong>Bin ID</strong>。</li>
              <li>左侧进入 <em>API Keys</em>，复制 <strong>X-Master-Key</strong>。</li>
              <li>回到应用“同步设置”，分别粘贴 <em>Bin ID</em> 与 <em>X-Master-Key</em>，保存即可。</li>
            </ol>
          </li>
          <li><strong>功能介绍</strong>：点击右上角云图标可手动“合并同步”（读取云端 → 合并 → 条件写回）；可在设置中开启“自动同步”。</li>
          <li><strong>多设备同步</strong>：在其它设备打开本应用，填入相同的 <em>Bin ID</em> 与 <em>X-Master-Key</em> 并保存，即可合并并保持同步。</li>
          <li><strong>按钮说明</strong>：
            <ul>
              <li><strong>云图标</strong>：点击手动同步；悬停/长按查看状态（同步中旋转、成功实心、失败红色、离线带斜杠）。</li>
              <li><strong>同步设置</strong>：<em>自动同步</em> 开关、<em>保存</em>；<em>高级设置</em> 中含 <em>仅拉取（覆盖本地）</em>、<em>仅上传（覆盖云端）</em>、<em>测试连接</em>、<em>解除绑定</em>；<em>显示/隐藏 API Key</em> 用于临时查看密钥。</li>
            </ul>
          </li>
        </ul>

        <p><strong>记功能说明</strong></p>
        <ul>
          <li><strong>用途</strong>：记录一次事件/原因/里程碑，不计入总数。</li>
          <li><strong>显示</strong>：在历史里以“记录”徽章呈现，可添加/编辑备注。</li>
          <li><strong>删除</strong>：删除“记录”不会改变当前值。</li>
          <li><strong>适合场景</strong>：写下为何 +1、补充上下文、仅做笔记等。</li>
        </ul>

        <p><strong>历史记录</strong></p>
        <ul>
          <li>在“历史记录”里可为每一条添加/编辑备注，或点垃圾桶删除。</li>
          <li>删除 <span class="kbd">+1</span> 条目会回退计数；删除“记录”不会改变计数。</li>
        </ul>

        <p><strong>排序与管理</strong></p>
        <ul>
          <li>桌面端拖动卡片即可排序；移动端在“更多”里用 上移/下移/置顶/置底。</li>
          <li>“更多”里可 <em>重命名</em>、<em>重置</em>（清零并清空历史）、或 <em>删除</em> 计数器。</li>
        </ul>

        <p><strong>数据与安装</strong></p>
        <ul>
          <li>右上角“更多”可 <em>导入/导出 JSON</em>。</li>
          <li>数据仅保存在浏览器本地，可离线使用；可在全局“清空”里一键清除。</li>
          <li>支持安装为应用（PWA）：Chrome/Edge/Android 菜单“安装/添加到主屏幕”；iOS Safari 共享菜单“添加到主屏幕”。</li>
        </ul>
      </div>
    </dialog>

    <script src="app.js"></script>
    <script>
      // Register Service Worker. On localhost, still enable SW when running as an installed PWA
      // so the app can work offline without the local Python server.
      (function() {
        if (!('serviceWorker' in navigator)) return;
        const isLocalhost = /^(localhost|127\.0\.0\.1)$/i.test(location.hostname);
        const isStandalone = (window.matchMedia && (
          window.matchMedia('(display-mode: standalone)').matches ||
          window.matchMedia('(display-mode: window-controls-overlay)').matches
        )) || (navigator.standalone === true);

        // In normal browser tabs on localhost, avoid SW to keep dev simple
        if (isLocalhost && !isStandalone) {
          navigator.serviceWorker.getRegistrations().then((regs) => {
            if (regs && regs.length) {
              Promise.all(regs.map(r => r.unregister())).then(() => {
                if (navigator.serviceWorker.controller) {
                  location.reload();
                }
              });
            }
          });
          return;
        }

        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (refreshing) return; refreshing = true;
          location.reload();
        });
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' })
            .then((reg) => { try { if (reg && typeof reg.update === 'function') reg.update(); } catch(e){} })
            .catch((e) => console.debug('SW register failed', e));
        });
      })();
    </script>
  </body>
  </html>
